# Regami Staging Docker Compose
# Simplified single-VM stack (no Patroni/etcd HA)
# For use on VM3-STAGING
#
# Usage:
#   docker compose -f docker-compose.yml up -d

services:
  # Caddy reverse proxy with automatic HTTPS
  caddy:
    image: caddy:2-alpine
    container_name: regami-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api
      - web
    networks:
      - regami-net

  # Regami API (FastAPI)
  api:
    image: ghcr.io/benj-n/regami-api:${IMAGE_TAG:-latest}
    container_name: regami-api
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
      - SECRET_KEY=${SECRET_KEY}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - APP_ENV=staging
      - STORAGE_BACKEND=s3
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_ACCESS_KEY=${MINIO_ROOT_USER}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - S3_REGION=ca-central-1
      - S3_BUCKET=regami
      - S3_PUBLIC_BASE_URL=${S3_PUBLIC_BASE_URL}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=staging
      - BASIC_AUTH_USERNAME=${BASIC_AUTH_USERNAME}
      - BASIC_AUTH_PASSWORD=${BASIC_AUTH_PASSWORD}
    depends_on:
      - postgres
      - minio
    networks:
      - regami-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Regami Web (Vite/React static)
  web:
    image: ghcr.io/benj-n/regami-web:${IMAGE_TAG:-latest}
    container_name: regami-web
    restart: unless-stopped
    networks:
      - regami-net

  # PostgreSQL (standalone, no HA)
  postgres:
    image: postgres:16-alpine
    container_name: regami-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - regami-net
    # IOPS optimization via command line args
    command: >
      postgres
      -c shared_buffers=1GB
      -c effective_cache_size=3GB
      -c work_mem=64MB
      -c maintenance_work_mem=256MB
      -c synchronous_commit=off
      -c checkpoint_timeout=15min
      -c checkpoint_completion_target=0.9
      -c max_wal_size=2GB
      -c min_wal_size=512MB
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c wal_buffers=64MB

  # MinIO - S3-compatible object storage
  minio:
    image: minio/minio:RELEASE.2024-01-01T16-36-33Z
    container_name: regami-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - regami-net
    ports:
      - "9000:9000"
      - "9001:9001"

volumes:
  caddy_data:
  caddy_config:
  postgres_data:
  minio_data:

networks:
  regami-net:
    driver: bridge
